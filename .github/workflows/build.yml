name: Build TrollSpeed (.tipa / .deb)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: 🧩 Checkout Repository
        uses: actions/checkout@v4
        with:
          path: TrollSpeed
          submodules: recursive

      - name: 🧰 Install Dependencies
        run: |
          brew install ldid dpkg zip
          sudo gem install xcpretty
          echo "✅ Installed dependencies"

      - name: ⚙️ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: 🔐 Prepare Scripts
        run: |
          cd TrollSpeed
          chmod +x build.sh || true
          chmod +x gen-control.sh || true
          echo "✅ Scripts ready"

      - name: 🧱 Get Version Info
        id: version
        run: |
          VERSION_TAG=$(git describe --tags --always || echo "v1.0.0")
          echo "VERSION=${VERSION_TAG}" >> $GITHUB_ENV
          echo "📦 Version: ${VERSION_TAG}"

      - name: 🧩 Generate DEB Control
        run: |
          cd TrollSpeed
          ./gen-control.sh ${{ env.VERSION }} || true

      - name: 🚀 Build .tipa (Xcode + fallback)
        run: |
          cd TrollSpeed
          ./build.sh ${{ env.VERSION }}

      - name: 🧾 Fix DEBIAN Permissions
        run: |
          cd TrollSpeed
          [ -d "layout/DEBIAN" ] && chmod 755 layout/DEBIAN/* || true

      - name: 📦 Package .deb
        run: |
          cd TrollSpeed
          if [ -d "layout/DEBIAN" ]; then
            mkdir -p packages
            dpkg-deb -b layout packages/TrollSpeed_${{ env.VERSION }}_arm64.deb
          fi

      - name: ☁️ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrollSpeed_Packages
          path: |
            ${{ github.workspace }}/TrollSpeed/packages/*.tipa
            ${{ github.workspace }}/TrollSpeed/packages/*.deb

      - name: 🚀 Upload to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            TrollSpeed/packages/*.tipa
            TrollSpeed/packages/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
