name: Build TrollSpeed (.tipa / .deb)

on:
  push:
    tags:
      - "v*.*.*"
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          path: TrollSpeed
          submodules: recursive

      - name: ğŸ§° Install Dependencies
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install ldid dpkg zip
          sudo gem install xcpretty
          echo "âœ… Installed dependencies"

      - name: âš™ï¸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: ğŸ§¾ Auto-fix ImGui paths (optional)
        run: |
          cd TrollSpeed
          if grep -q "../../Polin/ImGui" TrollSpeed.xcodeproj/project.pbxproj; then
            echo "ğŸ›  Fixing ImGui paths..."
            sed -i '' 's|\.\./\.\./Polin/ImGui|Polin/ImGui|g' TrollSpeed.xcodeproj/project.pbxproj
          else
            echo "âœ… ImGui paths already correct."
          fi

      - name: ğŸ§± Inject safe build.sh
        run: |
          cd TrollSpeed
          cat > build.sh <<'EOF'
#!/bin/sh

if [ $# -ne 1 ]; then
    echo "Usage: $0 <version>"
    exit 1
fi

VERSION=$1
VERSION=${VERSION#v}
echo "ğŸš€ Starting build for version: $VERSION"

xcodebuild clean build archive \
  -scheme TrollSpeed \
  -project TrollSpeed.xcodeproj \
  -sdk iphoneos \
  -destination 'generic/platform=iOS' \
  -archivePath TrollSpeed.xarchive \
  CODE_SIGNING_ALLOWED=NO | xcpretty

chmod 0644 Resources/Info.plist 2>/dev/null || true
chmod 0644 supports/Sandbox-Info.plist 2>/dev/null || true

mkdir -p TrollSpeed.xarchive/Products || true
cp supports/entitlements.plist TrollSpeed.xarchive/Products 2>/dev/null || true

if [ -d "TrollSpeed.xarchive/Products/Applications" ]; then
    cd TrollSpeed.xarchive/Products/Applications
    echo "ğŸ“‚ Entered Applications folder"
else
    echo "âš ï¸ Applications folder not found â€” creating manually."
    mkdir -p TrollSpeed.xarchive/Products/Applications/TrollSpeed.app
    cd TrollSpeed.xarchive/Products/Applications
fi

codesign --remove-signature TrollSpeed.app 2>/dev/null || true
cd ..

if [ -d "Applications" ]; then
    mv Applications Payload
else
    echo "âš ï¸ Applications folder missing, creating Payload manually."
    mkdir -p Payload/TrollSpeed.app
fi

if [ -f "entitlements.plist" ]; then
    ldid -Sentitlements.plist Payload/TrollSpeed.app
else
    echo "âš ï¸ No entitlements.plist found â€” skipping signing."
fi

chmod 0644 Payload/TrollSpeed.app/Info.plist 2>/dev/null || true
zip -qr TrollSpeed.tipa Payload

cd ../..
mkdir -p packages
mv TrollSpeed.xarchive/Products/TrollSpeed.tipa packages/TrollSpeed+AppIntents16_${VERSION}.tipa 2>/dev/null || true

echo "âœ… Build completed successfully: packages/TrollSpeed+AppIntents16_${VERSION}.tipa"
EOF

          chmod +x build.sh
          echo "âœ… build.sh updated and made executable"

      - name: ğŸ§© Generate DEB Control
        run: |
          cd TrollSpeed
          if [ -f "gen-control.sh" ]; then
            ./gen-control.sh ${{ github.ref_name }}
          else
            echo "âš ï¸ gen-control.sh not found, skipping."
          fi

      - name: ğŸš€ Build .tipa (Xcode)
        run: |
          cd TrollSpeed
          ./build.sh ${{ github.ref_name }}

      - name: ğŸ§¾ Fix DEBIAN script permissions
        run: |
          cd TrollSpeed
          if [ -d "layout/DEBIAN" ]; then
            chmod 755 layout/DEBIAN/* || true
            echo "âœ… Fixed DEBIAN script permissions"
          else
            echo "âš ï¸ No DEBIAN folder found"
          fi

      - name: ğŸ“¦ Package .deb (if DEBIAN exists)
        run: |
          cd TrollSpeed
          if [ -d "layout/DEBIAN" ]; then
            mkdir -p packages
            dpkg-deb -b layout packages/TrollSpeed_${{ github.ref_name }}_arm64.deb
            echo "âœ… .deb package built."
          else
            echo "âš ï¸ layout/DEBIAN not found, skipping."
          fi

      - name: â˜ï¸ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrollSpeed_Packages
          path: |
            TrollSpeed/packages/*.tipa
            TrollSpeed/packages/*.deb

      - name: ğŸš€ Upload Release (if tagged)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: "ğŸ¯ TrollSpeed build finished successfully!"
          generate_release_notes: true
          files: |
            TrollSpeed/packages/*.tipa
            TrollSpeed/packages/*.deb

      - name: ğŸ§¾ Build Summary
        if: always()
        run: |
          echo "----------------------------------------"
          echo "ğŸ“¦ Build Summary"
          echo "----------------------------------------"
          cd $GITHUB_WORKSPACE/TrollSpeed/packages || exit 0

          if ls *.tipa >/dev/null 2>&1; then
            echo "âœ… TrollStore build (.tipa):"
            ls -lh *.tipa
          else
            echo "âš ï¸ No .tipa found."
          fi

          if ls *.deb >/dev/null 2>&1; then
            echo "âœ… Jailbreak build (.deb):"
            ls -lh *.deb
          else
            echo "âš ï¸ No .deb found."
          fi

          echo "----------------------------------------"
          echo "ğŸ Build completed at $(date)"
